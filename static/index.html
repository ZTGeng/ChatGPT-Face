<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open AI Chatting</title>
    <meta name="author" content="Geng">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://unpkg.com/video.js/dist/video-js.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app" class="container" style="height: 100vh">
        <nav class="navbar fixed-top navbar-light bg-light">
            <div class="container-fluid">
                <h1 class="navbar-brand">{{ page_title }}</h1>
                
                <form class="">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" v-model="api_key_choice"name="apiKeyChoice" value="default" id="apiKeyChoiceDefault" checked>
                        <label class="form-check-label" for="apiKeyChoiceDefault">
                            {{ api_key_choice_default }}
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" v-model="api_key_choice" name="apiKeyChoice" value="custom" id="apiKeyChoiceCustom">
                        <label class="form-check-label me-2" for="apiKeyChoiceCustom">
                            {{ api_key_choice_custom }}
                        </label>
                        <input class="me-2" type="text" placeholder="API-KEY" v-model="api_key_custom" aria-label="API-KEY">
                        <a class="form-check-label fw-bold me-2 alert-link" href="https://openai.com/pricing" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom" :title="api_key_explanation">&#9432;</a>
                    </div>
                </form>
            </div>
        </nav>
        
        <div class="row" style="min-height: 100%">
            <div class="col col-4" style="min-height: 100%">
                <div class="d-inline-flex flex-column justify-content-end" style="width: 100%; min-height: 100%;">
                    <video id="robot-video" class="video-js mb-3"></video>
                    <div style="height: 200px"></div>
                </div>
            </div>
            <div class="col" style="min-height: 100%">
                <div class="d-inline-flex flex-column justify-content-end" style="width: 100%; min-height: 100%;">
                    <div style="height: 200px"></div>
                    <div v-for="message in messages" class="mb-3" :class="message.type === 'bot' ? 'me-auto' : message.type === 'human' ? 'ms-auto' : 'mx-auto'">
                        <div class="card" :class="message.type === 'bot' ? 'bg-light text-dark me-3' : message.type === 'human' ? 'bg-primary text-white ms-3' : 'bg-danger text-white'">
                            <div class="card-body text-pre" v-html="message.text"></div>
                        </div>
                    </div>
                    <div style="min-height: 200px"></div>
                </div>
            </div>
        </div>
        
        <nav class="navbar fixed-bottom navbar-light bg-light">
            <div class="container-fluid">
                <div class="input-group mb-3 px-3">
                    <textarea type="text" class="form-control me-2" aria-label="Message" aria-describedby="send-button" style="max-height: 150px;"
                        :placeholder="message_input_placeholder" 
                        v-model="message"
                        @keydown.enter.shift.prevent="sendMessages "></textarea>
                    <button class="btn btn-outline-secondary" type="button" id="send-button" @click="sendMessages" :disabled="state !== states.IDLE">{{ message_button_send }}</button>
                </div>
            </div>
        </nav>


    </div>

    <script src="https://unpkg.com/video.js/dist/video.js"></script>
    
    <script>
        let player = null; // 使用全局变量是因为 video.js 的一个 bug。详见 https://github.com/videojs/video.js/issues/7418
        const BOT_STATE = {
            IDLE: 'idle',
            LISTENING: 'listening',
            TYPING: 'typing',
            SPEAKING: 'speaking',
            DRAWING: 'drawing',
            ERROR: 'error'
        };
        const { createApp } = Vue;
        const app = createApp({
            data() {
                const resources = navigator.language.slice(0, 2) === "zh" ?
                {
                    page_title: 'Open AI 聊天',
                    api_key_choice_default: '使用本站 OPENAI API-KEY（有流量限制）',
                    api_key_choice_custom: '使用我的 OPENAI API-KEY：',
                    api_key_explanation: `关于 OPENAI API-KEY：
目前注册 openai.com 开发者用户时，会获得 5 美元的免费额度。
开发者用户可以免费创建 API-KEY，但是使用 API-KEY 时会消耗额度。
在免费额度用完后，需要提供有效付款方式继续使用API-KEY。
并不推荐在不受信任的站点使用自己的 API-KEY。
了解详细信息请点击。`,
                    message_input_placeholder: 'Shift + Enter 发送',
                    message_button_send: '发送',
                    server_error_message: '服务器发生错误，请稍后再试。',
                    error_codes: {
                        0: '发生了未知错误，请稍后再试。',
                        1: '本站 API-KEY 当前小时的流量已用完，请在下一个整点重试。',
                        2: '您提供的 API-KEY 无效。',
                        3: 'API 因访问太过频繁而被暂时限制使用，请稍后再试。',
                        4: 'OPENAI 服务器响应超时，请稍后再试。',
                    },
                } :
                {
                    page_title: 'Open AI Chatting',
                    api_key_choice_default: 'Use OPENAI API-KEY On This Site (Limited Traffic)',
                    api_key_choice_custom: 'Use My OPENAI API-KEY:',
                    api_key_explanation: `About OPENAI API-KEY:
Currently, when registering as a developer user on openai.com, you will receive $5 in free credits.
Developer users can create API-KEYs for free, but using API-KEYs will consume credits.
After the free credits are used up, you need to provide a valid payment method to continue using API-KEYs.
It is not recommended to use your own API-KEY on untrusted sites.
Click for more information.`,
                    message_input_placeholder: 'Shift + Enter to send',
                    message_button_send: 'Send',
                    server_error_message: 'Server error, please try again later.',
                    error_codes: {
                        0: 'An unknown error occurred, please try again later.',
                        1: 'The hourly traffic of the API-KEY on this site has been used up, please try again at the next hour.',
                        2: 'Your API-KEY is invalid.',
                        3: 'The API usage is temporarily restricted due to excessive access, please try again later.',
                        4: 'OPENAI server response timed out, please try again later.',
                    },
                };
                const props = {
                    api_key_choice: 'default',
                    api_key_custom: '',
                    message: '',
                    socket: null,
                    states: BOT_STATE,
                    state: BOT_STATE.IDLE,
                    messages: [],
                    videoOptions: {
                        width: 256,
                        height: 256,
                        poster: 'static/face_2.jpg',
                        autoplay: false,
                        controls: true,
                        sources: [
                            // {
                            //     src: 'temp/hls/output_hls.m3u8',
                            //     type: 'application/x-mpegURL'
                                // src: 'static/output200.mp4',
                                // type: 'video/mp4'
                            // }
                        ]
                    }
                };
                return { ...resources, ...props};
            },
            methods: {
                sendMessages() {
                    if (this.message === '') {
                        return
                    }
                    if (this.state !== BOT_STATE.IDLE) {
                        return
                    }

                    const data = {
                        key_type: this.api_key_choice,
                        message: this.message,
                    }
                    if (this.api_key_choice === 'custom') {
                        data.api_key = this.api_key_custom;
                    }
                    this.messages.push({
                        text: this.decorateMessage(this.message),
                        type: 'human'
                    });
                    this.message = '';
                    this.state = BOT_STATE.LISTENING;
                    
                    axios.post('/api/message', data)
                        .then(response => {
                            // this.state = BOT_STATE.TYPING;
                            // initWebSocket();
                            this.state = BOT_STATE.IDLE;
                            if (response.data.error_code) {
                                this.messages.push({
                                    text: this.error_codes[response.data.error_code],
                                    type: 'error'
                                });
                                return
                            }
                            this.messages.push({
                                text: this.decorateMessage(response.data.message),
                                type: 'bot'
                            });
                        })
                        .catch(error => {
                            this.messages.push({
                                text: this.server_error_message,
                                type: 'error'
                            });
                            this.state = BOT_STATE.IDLE;
                            console.log(error);
                        });
                },
                test() {
                    player.src({
                        // src: 'temp/hls/12l5c_hls.m3u8',
                        // type: 'application/x-mpegURL'
                        src: 'temp/output200_fps15.mp4',
                        type: 'video/mp4'
                    });
                    // this.player.load();
                    player.play();
                },
                decorateMessage(message) {
                    var newMessage = '';
                    message.trim().split("```").forEach((item, index) => {
                        if (index % 2 === 1) {
                            newMessage += "<pre class='mb-0 pb-3 px-3 bg-dark text-white'><code>" + item + "</code></pre>";
                        } else {
                            // “<br>”数等于连续的“\n”数除以 2 向上取整
                            newMessage += item.replace(/\n\n/g, "<br>").replace(/\n/g, "<br>");
                        }
                    });
                    return newMessage;
                },
            },
            mounted() {
                player = videojs(document.getElementById('robot-video'), this.videoOptions, () => {
                    // this.player.log('onPlayerReady', this);
                    console.log('onPlayerReady')
                });
                player.removeChild('BigPlayButton');
                player.getChild('ControlBar').removeChild('fullscreenToggle');
                player.on('ended', () => {
                    player.hasStarted(false);
                });
                // player.play();
            },
        });
        app.mount('#app');
    </script>
</body>
</html>